/*! surt 31-07-2013 */
!function(a){function b(a){var b=new RegExp(d,"g");return a.replace(b," ")}var c,d=String.fromCharCode(160),e=function(b){function d(a,b){if(!a||1!=a.nodeType)throw new Error("Surt: html element "+b+" not found or it has wrong nodeType")}if(b=b||{},c=a.jQuery||b.$){b&&b.root||!this||!this[0]||1!=this[0].nodeType||(b.root=this[0]);try{if(b.root=c(b.root)[0],d(b.root,"params.root"),b.input&&(b.input=c(b.input)[0]),b.input||(b.input=c('[contenteditable="true"]',b.root)),d(b.input,"params.input"),"true"==c(b.root).attr("data-surt-inited"))throw new Error("Surt: already initialized");ret=new e.fn.constructor(b,c)}catch(f){return console.warn(f.name+": ",f.message),void 0}return ret}};e.fn={constructor:function(a,b){function c(){clearTimeout(d._upTimer),d._upTimer=setTimeout(function(){d._pressedKeys=0},300)}var d=this;a=a||{},this.params=a,this.parser=e.parser,this.inputNode=b(a.input)[0],this.root=b(a.root)[0],this.suggestNode=b(a.suggest)[0],this.cloneNode=b(a.clone)[0],this.autocompleteNode=b(a.autocomplete)[0],this._pressedKeys=0,this.kit=[],b(this.root).attr("data-surt-inited",!0),b(this.inputNode).on("keydown",function(){d._pressedKeys++,c()}).on("keyup",function(c){var e=c.keyCode;return d._pressedKeys--,37==e||39==e||16==e||17==e||18==e||91==e||35==e||36==e?!0:(40==e&&b(".surt").hasClass(a.suggestCls),d.parse(),a.change&&a.change(c,d.args()),void 0)}).on("keydown input paste",function(a){return 13==a.keyCode?!1:void 0}).on("paste",function(){setTimeout(function(){d.parse()},0)}).on("focus",function(){b(".surt").addClass("surt_state_focus")}).on("blur",function(){b(".surt").removeClass("surt_state_focus")})},dispose:function(){c(this.root).attr("data-surt-inited","disposed"),clearTimeout(this._upTimer)},get:function(){return this.kit},set:function(a){this._pressedKeys||(a=a||{},this.kit=a.kit||[],this.suggest=a.suggest||[],this.update())},update:function(){this.saveCursor();for(var a=[],b=[],e=this.params.kitCls,f=this.params.textCls||e,g=0;g<this.kit.length;g++){var h=this.kit[g].text.trim();"text"!=this.kit[g].type?(e&&(h='<div class="'+e+" "+e+"_type_"+this.kit[g].type+'">'+h+"</div>"),a.push(h)):(f&&(h='<div class="'+f+'">'+h+"</div>"),a.push(h))}a=a.join(" "),this.trailingSpace&&(a+=d),this.inputNode.innerHTML=a;for(var g=0;g<this.suggest.length;g++){for(var i=[],j=0;j<this.suggest[g].length;j++){var h=this.suggest[g][j].text.trim();"text"!=this.suggest[g][j].type?(e&&(h='<div class="'+e+" "+e+"_type_"+this.suggest[g][j].type+'">'+h+"</div>"),i.push(h)):(f&&(h='<div class="'+f+'">'+h+"</div>"),i.push(h))}i=i.join(" "),b.push('<li class="'+this.params.suggestItemCls+'">'+i+"</li>")}if(b=b.join(""),this.suggestNode&&(b?c(this.root).addClass(this.params.suggestCls):c(this.root).removeClass(this.params.suggestCls),this.suggestNode.innerHTML=b),this.suggest.length&&this.suggest[0].length&&this.kit.length){var k=this.kit[this.kit.length-1].text,l=this.suggest[0][this.suggest[0].length-1].text,m=!l.toLowerCase().indexOf(k.toLowerCase());c(this.root).hasClass(this.params.suggestCls)&&m?(this.cloneNode.innerHTML=this.inputNode.innerHTML,this.autocompleteNode.innerHTML=l.slice(k.length),c(this.root).addClass(this.params.autocompleteCls)):c(this.root).removeClass(this.params.autocompleteCls)}else c(this.root).removeClass(this.params.autocompleteCls);this.restoreCursor()},query:function(a){var c="";a=a||this.kit;for(var d=0;d<a.length;d++)d>0&&(c+=" "),c+=a[d].text;return b(c)},text:function(){return b(c(this.inputNode).text())},args:function(){var a={};return a.kit=this.kit,a.suggest={},a.text=this.text(),a},parse:function(){var a=this.text();this.trailingSpace=" "===a[a.length-1],newKit=this.parser(this.kit,a),this.kit=newKit}},e.fn.constructor.prototype=e.fn,a.surt=e,"undefined"!=typeof module&&(module.exports=e),e.version="0.1.0"}(this),function(a,b){function c(a){for(var b="",c=0;c<a.length;c++)c>0&&(b+=" "),b+=a[c].text;return b}var d=a.surt||{},e=function(a,d){function e(a){"text"==a.type&&f.length&&"text"==f[f.length-1].type?f[f.length-1].text+=" "+a.text:f.push(a),d=d.replace(a.text,"").trim()}var f=[];if(c(a)===d)return a;for(var g=0;g<a.length;g++){var h=d.indexOf(a[g].text),i=d[h-1],j=d[h+a[g].text.length];if((" "!==j&&j!==b||" "!==i&&i!==b)&&(h=-1),0==h)e(a[g]);else if(h>0){var k=d.substring(0,h).trim();e({text:k,type:"text"}),e(a[g])}}return d&&e({text:d,type:"text"}),f};d.parser=e,"undefined"!=typeof module&&(module.exports=e)}(this),function(a){function b(a,b){for(var c=0,d=0;d<a.childNodes.length;d++){var e=$(a.childNodes[d]).text().length;if(c+=e,c>=b)return{child:a.childNodes[d],n:b-(c-e)}}return 0>b&&(c=0),{child:a.childNodes[a.childNodes.length-1],n:c}}var c=a.surt||{};c.fn=c.fn||{},c.fn.saveCursor=function(){if(a.getSelection){var b=a.getSelection();if(b.anchorNode){for(var c=b.getRangeAt(0),d=c.startContainer,e=c.startOffset,f=d,g=e;f&&f!=this.inputNode;){for(var h,i=f.previousSibling;i;)h=$(i).text(),g+=h.length,i=i.previousSibling;f=f.parentNode}return this.cursorPos=g,g}}},c.fn.restoreCursor=function(c){if(a.getSelection){var d=document.createRange(),e=a.getSelection(),f=this.inputNode;for(c=c||this.cursorPos;f&&1==f.nodeType;)obj=b(f,c),f=obj.child,c=obj.n;f&&3==f.nodeType&&(d.setStart(f,c),d.collapse(!0),e.removeAllRanges(),e.addRange(d)),this.inputNode.focus()}}}(this);